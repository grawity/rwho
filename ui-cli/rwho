#!/usr/bin/env bash
# rwho - simple 'finger' client hardcoded to query a rwho-ng server

[[ $DEBUG ]] && set -x

RWHO_DIR="/cluenet/rwho"

RWHO_HOST='rwho.cluenet.org'
RWHO_PORT='finger'
RWHO_URL="http://$RWHO_HOST/"

CONFIG="$RWHO_DIR/rwho.conf"

if [[ -s $CONFIG ]]; then
	re='^\s*([^;#][^\s]+)\s*=\s*(.*)$'
	while read -r line; do
		if [[ $line =~ $re ]]; then
			key=${BASH_REMATCH[1]}
			val=${BASH_REMATCH[2]}
			case $key in
			'finger.host')
				RWHO_HOST=$val;;
			'finger.port')
				RWHO_PORT=$val;;
			'agent.notify_url')
				RWHO_URL=${val#server.php};;
			esac
		fi
	done < "$CONFIG"
fi

usage() {
	echo "Usage: ${0##*/} [-l] [-v] [user][@host]"
	echo ""
	echo "  -l  list hosts"
	echo "  -v  verbose output"
	echo ""
	echo "HTTP interface is available at: $RWHO_URL"
	echo ""
	echo "This version of rwho was developed by grawity <grawity@gmail.com>"
	exit 2
}

filter() {
	perl -pe 's/\033/"^".chr(ord($&)+0100)/ge'
}

conn() {
	local request=$1 fd=
	exec {fd}<>"/dev/tcp/$RWHO_HOST/$RWHO_PORT" || {
		echo >&2 "rwho: connection failed ($?)"
		return 1
	}
	printf >&$fd '%s\r\n' "$request"
	filter <&$fd
	exec {fd}>&-
}

opt_l=false
hosts=false
long=false

while getopts ":lv" OPT; do
	case $OPT in
	'l')	opt_l=true;;
	'v')	long=true;;
	'?')	echo "Unknown option '$OPTARG'" >&2;
		usage;;
	esac
done
shift $((OPTIND-1))

query=$1

if $opt_l; then
	if [[ $query ]]; then
		long=true
		query="/W $query"
	else
		hosts=true
		query="*"
	fi
fi

conn "$query"
